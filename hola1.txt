#include <sourcemod>
#include <sdktools>
#include <sdkhooks>
#include <socket>
#include <adminmenu>
#include <l4d2_stocks>
#include "../include/mgcore.inc"
#include "sourcebans.inc"
#include "help.sp"
#include "communication.sp"
#include "events.sp"
#include "config.sp"
#pragma semicolon 0

//Compile options
#define VERSION "1.0.2.0"
#define DEBUG 0
#define DEV 0

//Others
#define DB_NAME	"hidden_infected"

//Models
#define WITCH_MODEL 						"models/infected/witch.mdl"
#define NICK 								"models/survivors/survivor_gambler.mdl"
#define ROCHELLE 							"models/survivors/survivor_producer.mdl"
#define COACH 								"models/survivors/survivor_coach.mdl"
#define ELLIS 								"models/survivors/survivor_mechanic.mdl"
#define BILL 								"models/survivors/survivor_namvet.mdl"
#define ZOEY 								"models/survivors/survivor_teenangst.mdl"
#define FRANCIS 							"models/survivors/survivor_biker.mdl"
#define LOUIS 								"models/survivors/survivor_manager.mdl"
#define FELLOW_INFECTED_MODEL				"models/props_fairgrounds/alligator.mdl"
#define MINE_BOUNDARY						"models/props_placeable/striped_barricade_startingarea.mdl"
#define MINE_MODEL 							"models/props_lab/powerbox02d.mdl"
#define VOMIT_MINE_MODEL					"models/infected/limbs/exploded_boomer_steak2.mdl"
#define NAPALM_MINE_MODEL					"models/props/cs_office/fire_extinguisher.mdl"
#define DNA_SCAN_POSITION_MODEL				"models/props_urban/wood_post002.mdl"
#define GIB_1								"models/infected/limbs/common_infected_w_l_arm_upper_gib.mdl"
#define GIB_2								"models/infected/limbs/common_infected_w_l_leg_lower_gib.mdl"
#define GIB_3								"models/infected/limbs/common_infected_w_head5_gib.mdl"
#define GIB_4								"models/infected/limbs/common_infected_w_r_leg_lower_gib.mdl"
#define GIB_5								"models/infected/limbs/common_infected_w_torso_gib1.mdl"
#define GIB_6 								"models/infected/limbs/common_infected_w_torso_gib3.mdl"
#define GIB_7 								"models/infected/limbs/common_infected_w_torso_gib2.mdl"
#define GIB_8 								"models/infected/limbs/common_infected_w_l_leg_lower_gib.mdl"
#define GIB_9 								"models/infected/limbs/common_infected_w_head7_gib.mdl"
#define GIB_10 								"models/infected/limbs/common_infected_w_head1_gib.mdl"
#define BARRICADE_MODEL_BROKEN_1			"models/props_unique/wooden_barricade_break1.mdl"
#define BARRICADE_MODEL_BROKEN_2			"models/props_unique/wooden_barricade_break2.mdl"

#define UNIT_AS_METRIC		19.05 //mm

//Hitgroups
#define	HITGROUP_GENERIC	0
#define	HITGROUP_HEAD		1
#define	HITGROUP_CHEST		2
#define	HITGROUP_STOMACH	3
#define HITGROUP_LEFTARM	4
#define HITGROUP_RIGHTARM	5
#define HITGROUP_LEFTLEG	6
#define HITGROUP_RIGHTLEG	7
#define HITGROUP_GEAR		10

//Particles
#define EXPLOSION_PARTICLE					"gas_explosion_main_fallback"
#define EXPLOSION_PARTICLE2 				"weapon_grenade_explosion"
#define EXPLOSION_PARTICLE3					"explosion_huge_b"
#define BOOMER_EXPLOSION_PARTICLE 			"boomer_explode"
#define TASE_PARTICLE						"electrical_arc_01_system"
#define NAPALM_BOOM_PARTICLE				"gas_fireball"
#define NAPALM_FIRE_PARTICLE				"fire_medium_03_brownsmoke"
#define BLOOD_ATOMIZED						"blood_atomized"
#define POISON_GAS							"smoker_smokecloud"

//Sounds
#define EXPLOSION_SOUND						"ambient/explosions/explode_1.wav"
#define EXPLOSION_SOUND2					"ambient/explosions/explode_2.wav"
#define EXPLOSION_SOUND3					"ambient/explosions/explode_3.wav"
#define AIR_EXPLOSION_SOUND					"ambient/fire/gascan_ignite1.wav"
#define	DNA_SCAN_SOUND						"buttons/blip2.wav"
#define DNA_SCAN_FAIL_SOUND					"buttons/blip2.wav"
#define BOOMER_EXPLOSION_SOUND				"player/boomer/explode/explo_medium_14.wav"
#define TASE_SOUND							"weapons/defibrillator/defibrillator_use.wav"
#define NAPALM_BOOM_SOUND					"ambient/atmosphere/firewerks_burst_04.wav"
#define SURPRISE_SOUND						"npc/moustachio/whackpopup04.wav"
#define KOS_SOUND							"ui/pickup_secret01.wav"
#define C4_WARNING_SOUND					"ui/beep22.wav"
#define POISON_GAS_RELEASE_SOUND			"player/smoker/death/smoker_explode_03.wav"
#define CONFUSION_YELL_SOUND				"player/hunter/voice/attack/shriek_1.wav"
#define NAPALM_DETECT						"ambient/alarms/klaxon1.wav"
#define TASER_READY_ONE						"ui/beepclear.wav"
#define TASER_READY_TWO						"ambient/energy/zap2.wav"
#define COUNTDOWN_60_SECS					"ui/survival_teamrec.wav"
#define COUNTDOWN_30_SECS					"ui/survival_playerrec.wav"
#define COUNTDOWN_15_SECS					"ui/survival_medal.wav"
#define COUNTDOWN_LAST_SECS					"buttons/blip1.wav"
#define ROUND_LOST							"level/lowscore.wav"

//Ammo indexes
#define ASSAULT_RIFLE_OFFSET_IAMMO			12
#define SMG_OFFSET_IAMMO					20
#define PUMPSHOTGUN_OFFSET_IAMMO			28
#define AUTO_SHOTGUN_OFFSET_IAMMO			32
#define HUNTING_RIFLE_OFFSET_IAMMO			36
#define MILITARY_SNIPER_OFFSET_IAMMO		40
#define GRENADE_LAUNCHER_OFFSET_IAMMO		68


#define BARRICADE_DAMAGE1 					"physics/wood/wood_panel_break1.wav"
#define BARRICADE_DAMAGE2 					"physics/wood/wood_plank_break1.wav"
#define BARRICADE_DAMAGE3 					"physics/wood/wood_plank_break3.wav"
#define BARRICADE_DAMAGE4 					"physics/wood/wood_plank_break4.wav"
#define BARRICADE_BREAK						"physics/wood/wood_crate_break5.wav"
#define BARRICADE_HEALTH					2250

#define ROUND_END_MUSIC 					"music/safe/themonsterswithout_l4d1.wav"
#define ROUND_END_MUSIC2 					"music/safe/themonsterswithout.wav"

#define ROUNDS_PER_MAP						5

#define FRANCIS_NAPALM_PAIN					"player/survivor/voice/biker/deathscream09.wav"
#define LOUIS_NAPALM_PAIN					"player/survivor/voice/manager/deathscream04.wav"
#define BILL_NAPALM_PAIN					"player/survivor/voice/namvet/deathscream04.wav"
#define ZOEY_NAPALM_PAIN					"player/survivor/voice/teengirl/deathscream10.wav"
#define NICK_NAPALM_PAIN					"player/survivor/voice/gambler/incapacitatedinjury04.wav"
#define COACH_NAPALM_PAIN					"player/survivor/voice/coach/deathscream02.wav"
#define ELLIS_NAPALM_PAIN					"player/survivor/voice/mechanic/incapacitatedinjury04.wav"
#define ROCHELLE_NAPALM_PAIN				"player/survivor/voice/producer/incapacitatedinjury02.wav"

#define HUD_FLAG_NONE	(0 << 0)	//Visible to nobody
#define HUD_FLAG_OWNER 	(1 << 0)	//Visible to owner
#define HUD_FLAG_TEAM	(1 << 1)	//Visible to friends
#define HUD_FLAG_ENEMY	(1 << 2)	//Visible to enemies

#define ABILITY_OFFSET 948

enum ResearchItems
{
	None = 0,
	Incapacitation,
	Taser,
	InfectionAlarm,
	Defuser,
	Tracker
}

public Plugin:myinfo = 
{
	name = "[L4D2] Hidden Infected",
	author = "Marvelous Gaming STAFF",
	description = "Hidden Infected game mode",
	version = VERSION,
	url = "mgftw.com/forum.php"
}

enum RoundProgress
{
	RS_Idle = 0,
	RS_WarmingUp,
	RS_WaitingForPlayers,
	RS_InProgress,
	RS_PostRoundEnd
};

enum Team
{
	All = 0,
	HiddenInfected,
	Detective,
	Scientist,
	Survivor,
	Spectator
};

#define WINREASON_NONE 0
#define WINREASON_INFECTED 1
#define WINREASON_SURVIVOR 2
#define WINREASON_TIMEOUT 3

//General Variables
new g_BeamSprite;	//Used to send beam stuff
new g_HaloSprite;	//Used to send beam stuff
new RoundProgress:g_iRoundProgress = RS_Idle; //Round State
new Float:g_flRoundStartTime; //Time that the round started
new bool:g_bBlockTimer;
new g_iTotalInfSpawnPoints;
new g_iTotalSpawnPoints;
new g_iTimeLeft = 0;
new Handle:g_hCorpseList;
new Float:g_vecSpawnPositions[256][3];
new Float:g_vecInfSpawnPositions[256][3];
new Float:g_flZMSpawnPoints[100][3];
new g_iZMTotalSpawnPoints;
new g_iCommonLimit;
new Float:g_flAttackInterval;
new Float:g_flLastAttack;
new Handle:g_hLastCorpseInfo;
new g_iRoundsPlayed = 0;
new bool:g_bUnlocked[16];
new g_iResearchTime[16];
new ResearchItems:g_iCurrentResearch;
new g_iTransitionInfo[MAXPLAYERS+1][6];
new bool:g_bDontBlockFallDamage = false;
new bool:g_bExpensiveC4 = false;
new bool:g_bBlockSaferoomTeleport;
new g_iLastWinReason = WINREASON_NONE;
new bool:g_bShown[2];
new bool:g_bConfusionYell = false;

//Entity Variables
new g_iHudFlags[2048];
new g_iHudOwner[2048];
new bool:g_bIsHIItem[2048];
new bool:g_bIsHUD[2048];
new g_iHIItemOwner[2048];
new bool:g_bIsBarricade[2048];
new g_bBarricadeModelApplied[2048][2];
new g_iBarricadeHealth[2048];
new Handle:g_hC4Info[2048];


//Player Variables
//-Buy stuff
//Infected
new bool:g_bHasSilencedShoes[MAXPLAYERS+1];
new bool:g_bHasHammer[MAXPLAYERS+1];
new bool:g_bHasGore[MAXPLAYERS+1];
new bool:g_bHasLeap[MAXPLAYERS+1];

//Detective
new bool:g_bHasDNAScanner[MAXPLAYERS+1];
new bool:g_bHasIntuition[MAXPLAYERS+1];
new bool:g_bHasTaser[MAXPLAYERS+1];
new bool:g_bHasDefuser[MAXPLAYERS+1];
new bool:g_bHasTracker[MAXPLAYERS+1];

new g_iCreditsGiven = 0;

//-State & Info
new g_iDNATrace[MAXPLAYERS+1];
new Float:g_flLastScanTime[MAXPLAYERS+1];
new g_iScanModel[MAXPLAYERS+1];
new g_iTrackerHUD[MAXPLAYERS+1];
new Team:g_iTeam[MAXPLAYERS+1];
new g_iPreviousButtons[MAXPLAYERS+1];
new g_bAboutToToggle[MAXPLAYERS+1];
new g_iCredits[MAXPLAYERS+1];
new g_iKills[MAXPLAYERS+1];
new bool:g_bCorpseFound[MAXPLAYERS+1];
new g_iLastAttacker[MAXPLAYERS+1];
new bool:g_bForceRagdoll[MAXPLAYERS+1];
new bool:g_bForceNoBody[MAXPLAYERS+1];
new bool:g_bWasHunter[MAXPLAYERS+1];
new g_iRoundsNotInfected[MAXPLAYERS+1];
new g_iChance[MAXPLAYERS+1] = {100, ...};
new g_iRoundRDM[MAXPLAYERS+1];
new g_iKarma[MAXPLAYERS+1] = {1000, ...};
new g_iInitialKarma[MAXPLAYERS+1] = {1000, ...};
new g_bKarmaLoaded[MAXPLAYERS+1];
new g_iHitGroup[MAXPLAYERS+1];
new Float:g_flLastConvert[MAXPLAYERS+1];
new Float:g_flCombatTimer[MAXPLAYERS+1];
new bool:g_bPotentialRDMER[MAXPLAYERS+1];
new g_iCombatStarter[MAXPLAYERS+1];
new bool:g_bWasDeadByC4[MAXPLAYERS+1] = false;
new bool:g_bTased[MAXPLAYERS+1];
new Float:g_flLastTase[MAXPLAYERS+1];
new Float:g_sViewStatsSteamId[MAXPLAYERS+1][64];
new Float:g_flMaxDamageTaken[MAXPLAYERS+1];
new Float:g_flMaxDamageDealt[MAXPLAYERS+1];

//Pointers
new Address:g_pNavMesh;
new Address:g_pDirector;
new Address:g_pZombieManager;

//Calls
new Handle:sdkDetonateFire = INVALID_HANDLE;
new Handle:sdkDetonatePipe = INVALID_HANDLE;
new Handle:sdkVomitSurvivor = INVALID_HANDLE;
new Handle:sdkVomitInfected = INVALID_HANDLE;
new Handle:sdkCreatePipeBomb = INVALID_HANDLE;
new Handle:sdkDetonateAcid = INVALID_HANDLE;
new Handle:sdkIsVisible = INVALID_HANDLE;
new Handle:sdkFling = INVALID_HANDLE;